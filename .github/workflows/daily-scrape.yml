name: Daily Course Scraper

on:
  schedule:
    - cron: '0 20 * * *' # 20:00 UTC = 05:00 KST
  workflow_dispatch:
    inputs:
      mode:
        description: 'full: Playwright + API / api: API only'
        required: false
        default: 'full'
      target:
        description: 'íŠ¹ì • ì§€ì—­/ê¸°ê´€ íƒ€ê²Ÿ (ì„ íƒ)'
        required: false
        default: ''

jobs:
  run-scrapers:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      DEFAULT_VAPID_SUBJECT: mailto:notifications@woodongbae.local
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: ğŸ› ï¸ Prepare runtime vars
        id: opts
        run: |
          MODE="${{ github.event.inputs.mode }}"
          TARGET="${{ github.event.inputs.target }}"
          echo "mode=${MODE:-full}" >> "$GITHUB_OUTPUT"
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ Install dependencies
        run: |
          corepack enable
          yarn install --frozen-lockfile

      - name: ğŸ­ Install Playwright (full mode only)
        if: steps.opts.outputs.mode == 'full'
        run: yarn playwright install --with-deps chromium

      - name: ğŸ” Write .env.local
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT: ${{ secrets.VAPID_SUBJECT }}
          DEFAULT_VAPID_SUBJECT: ${{ env.DEFAULT_VAPID_SUBJECT }}
        run: |
          : "${VAPID_SUBJECT:=}"
          SUBJECT_VALUE=$(echo "${VAPID_SUBJECT}" | tr -d '\r' | xargs)
          if [ -z "$SUBJECT_VALUE" ]; then
            SUBJECT_VALUE="$DEFAULT_VAPID_SUBJECT"
          fi
          echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> .env.local
          echo "SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY" >> .env.local
          echo "NEXT_PUBLIC_API_KEY=$NEXT_PUBLIC_API_KEY" >> .env.local
          echo "GEMINI_API_KEY=$GEMINI_API_KEY" >> .env.local
          echo "NEXT_PUBLIC_VAPID_PUBLIC_KEY=$NEXT_PUBLIC_VAPID_PUBLIC_KEY" >> .env.local
          echo "VAPID_PRIVATE_KEY=$VAPID_PRIVATE_KEY" >> .env.local
          echo "VAPID_SUBJECT=$SUBJECT_VALUE" >> .env.local

      - name: ğŸš€ Run scraper
        run: |
          MODE="${{ steps.opts.outputs.mode }}"
          TARGET="${{ steps.opts.outputs.target }}"

          if [ "$MODE" = "api" ]; then
            echo "ğŸŒ API ëª¨ë“œ ì‹¤í–‰"
            yarn tsx scrapers/seoul-api.ts
            exit $?
          fi

          if [ -n "$TARGET" ]; then
            echo "ğŸ¯ íƒ€ê²Ÿ ì‹¤í–‰: $TARGET"
            yarn tsx scrapers/main.ts --target="$TARGET"
          else
            echo "ğŸ”„ ì „ì²´ ì‹¤í–‰"
            yarn tsx scrapers/main.ts
          fi
