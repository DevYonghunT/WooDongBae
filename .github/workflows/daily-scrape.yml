name: Daily Course Scraper

on:
  schedule:
    - cron: '0 20 * * *' # 20:00 UTC = 05:00 KST
  workflow_dispatch:
    inputs:
      mode:
        description: 'full: Playwright + API / api: API only'
        required: false
        default: 'full'
      target:
        description: 'íŠ¹ì • ì§€ì—­/ê¸°ê´€ íƒ€ê²Ÿ (ì„ íƒ)'
        required: false
        default: ''

jobs:
  run-scrapers:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      DEFAULT_VAPID_SUBJECT: mailto:notifications@woodongbae.local
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: ğŸ› ï¸ Prepare runtime vars
        id: opts
        run: |
          MODE="${{ github.event.inputs.mode }}"
          TARGET="${{ github.event.inputs.target }}"
          echo "mode=${MODE:-full}" >> "$GITHUB_OUTPUT"
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¦ Install dependencies
        run: |
          corepack enable
          yarn install --frozen-lockfile

      - name: ğŸ­ Install Playwright (full mode only)
        if: steps.opts.outputs.mode == 'full'
        run: yarn playwright install --with-deps chromium

      - name: ğŸ” Check secrets wiring (safe)
        run: |
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then echo "secrets.NEXT_PUBLIC_SUPABASE_URL = EMPTY"; else echo "secrets.NEXT_PUBLIC_SUPABASE_URL = SET"; fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then echo "secrets.SUPABASE_SERVICE_ROLE_KEY = EMPTY"; else echo "secrets.SUPABASE_SERVICE_ROLE_KEY = SET"; fi


      - name: ğŸ” Write .env.local
        shell: bash
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEXT_PUBLIC_VAPID_PUBLIC_KEY: ${{ secrets.NEXT_PUBLIC_VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT: ${{ secrets.VAPID_SUBJECT }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          # 1) .env.localì€ í•­ìƒ "ë®ì–´ì“°ê¸°"ë¡œ ìƒì„± (ê¸°ì¡´ íŒŒì¼ ì˜í–¥ ì œê±°)
          rm -f .env.local

          # 2-1) Supabase secret ê²€ì¦
          SUPABASE_URL_VALUE="$(echo "${NEXT_PUBLIC_SUPABASE_URL:-}" | tr -d '\r' | xargs)"
          SUPABASE_KEY_VALUE="$(echo "${SUPABASE_SERVICE_ROLE_KEY:-}" | tr -d '\r' | xargs)"

          if [ -z "$SUPABASE_URL_VALUE" ]; then
            echo "âŒ Missing secret: NEXT_PUBLIC_SUPABASE_URL"
            exit 1
          fi

          if [ -z "$SUPABASE_KEY_VALUE" ]; then
            echo "âŒ Missing secret: SUPABASE_SERVICE_ROLE_KEY"
            exit 1
          fi

          # 2-2) VAPID subject ê²°ì •: secret ì—†ìœ¼ë©´ DEFAULTë¡œ ëŒ€ì²´
          SUBJECT_VALUE="$(echo "${VAPID_SUBJECT:-}" | tr -d '\r' | xargs)"
          if [ -z "$SUBJECT_VALUE" ]; then
            SUBJECT_VALUE="${DEFAULT_VAPID_SUBJECT}"
          fi

          # 3) ì•ˆì „í•˜ê²Œ íŒŒì¼ ì‘ì„± (ì„œë²„/í´ë¼ ë³€ìˆ˜ ëª¨ë‘ ë„£ì–´ì¤Œ)
          {
            printf 'NEXT_PUBLIC_SUPABASE_URL=%s\n' "$SUPABASE_URL_VALUE"
            printf 'SUPABASE_SERVICE_ROLE_KEY=%s\n' "$SUPABASE_KEY_VALUE"
            printf 'NEXT_PUBLIC_API_KEY=%s\n' "$NEXT_PUBLIC_API_KEY"
            printf 'GEMINI_API_KEY=%s\n' "$GEMINI_API_KEY"
            printf 'NEXT_PUBLIC_VAPID_PUBLIC_KEY=%s\n' "$NEXT_PUBLIC_VAPID_PUBLIC_KEY"
            printf 'VAPID_PUBLIC_KEY=%s\n' "$NEXT_PUBLIC_VAPID_PUBLIC_KEY"
            printf 'VAPID_PRIVATE_KEY=%s\n' "$VAPID_PRIVATE_KEY"
            printf 'DEFAULT_VAPID_SUBJECT=%s\n' "${DEFAULT_VAPID_SUBJECT}"
            printf 'VAPID_SUBJECT=%s\n' "$SUBJECT_VALUE"
            printf 'NEXT_PUBLIC_VAPID_SUBJECT=%s\n' "$SUBJECT_VALUE"
          } > .env.local

      # âœ… ì—¬ê¸°! (ë„¤ê°€ ëª°ëë˜ â€œì‹¤í–‰ step ì „ì— ë„£ëŠ”â€ ë””ë²„ê·¸ step)
      - name: ğŸ” Debug env/.env.local (safe)
        shell: bash
        run: |
          echo "---- file exists? ----"
          ls -la .env.local || true

          echo "---- .env.local has VAPID_SUBJECT? ----"
          grep '^VAPID_SUBJECT=' .env.local || true

          echo "---- dotenv load check (no secrets printed except subject) ----"
          node -e "require('dotenv').config({ path: '.env.local' }); console.log('dotenv VAPID_SUBJECT:', process.env.VAPID_SUBJECT || '<missing>')"
          node -e "require('dotenv').config({ path: '.env.local' }); console.log('dotenv NEXT_PUBLIC_SUPABASE_URL:', process.env.NEXT_PUBLIC_SUPABASE_URL ? 'set' : 'missing')"
          node -e "require('dotenv').config({ path: '.env.local' }); console.log('dotenv SUPABASE_SERVICE_ROLE_KEY:', process.env.SUPABASE_SERVICE_ROLE_KEY ? 'set' : 'missing')"

      - name: ğŸš€ Run scraper
        run: |
          MODE="${{ steps.opts.outputs.mode }}"
          TARGET="${{ steps.opts.outputs.target }}"

          if [ "$MODE" = "api" ]; then
            echo "ğŸŒ API ëª¨ë“œ ì‹¤í–‰"
            yarn tsx scrapers/seoul-api.ts
            exit $?
          fi

          if [ -n "$TARGET" ]; then
            echo "ğŸ¯ íƒ€ê²Ÿ ì‹¤í–‰: $TARGET"
            yarn tsx scrapers/main.ts --target="$TARGET"
          else
            echo "ğŸ”„ ì „ì²´ ì‹¤í–‰"
            yarn tsx scrapers/main.ts
          fi
